/***** =================== å¸¸æ•¸ =================== *****/
// é›²ç«¯ç¡¬ç¢Ÿè³‡æ–™å¤¾
const CSV_FOLDER_ID          = '13EtcaTzd2wApVbrSxkWQNgcKwMtuRiME';       // å‡æ—¥CSVä¾†æº
const CAL_FOLDER_ID          = '1drhxrK1Du2IwRAIywEtKfjByXHHyu0Hc';       // æ—¥æ›†è¼¸å‡ºè³‡æ–™å¤¾
const ROSTER_FOLDER_ID       = '1kTBYT75SmGZO976UpICWB_5rwRP8qA8d';       // ç­è¡¨è¼¸å‡ºè³‡æ–™å¤¾
const MIGRANT_OUT_FOLDER_ID  = '1JsylreRZdl9t_NZpZoOoaaLps7zFm1Nx';       // ç§»å·¥æ’ç­è¼¸å‡ºè³‡æ–™å¤¾

// å·¥ä½œè¡¨åç¨±
const TARGET_SHEET  = 'å‡æ—¥æ¸…å–®';
const DB_SHEET      = '_DB_ALL';
const PEOPLE_SHEET  = 'äººå“¡è¨­å®š';
const STATS_SHEET   = 'çµ±è¨ˆ';
const MIGRANT_SHEET = 'ç§»å·¥æ’ç­';

// è¨­å®šé å„²å­˜æ ¼ï¼ˆå‚™è¨»ç§»åˆ°å¹´æœˆä¸‹æ–¹ï¼‰
const YEAR_CELL   = 'è¨­å®š!A2';   // å¹´ï¼ˆ114/115 æˆ– 2025â€¦ï¼‰
const MONTH_CELL  = 'è¨­å®š!B2';   // æœˆï¼ˆ1~12ï¼‰
const STATUS_CELL = 'è¨­å®š!A4';   // ç‹€æ…‹åˆ—
const MOBILE_CELL = 'è¨­å®š!D3';   // TRUE=æ‰‹æ©Ÿæ¨¡å¼
const NOTE_CELL   = 'è¨­å®š!A6';   // å‚™è¨»ï¼ˆåŒæ­¥åˆ°ç­è¡¨/æ—¥æ›†ï¼›æ”¾åœ¨ A6ï¼Œåˆä½µ A6:D10ï¼‰

// éœ€æ±‚æ•¸ï¼ˆåœ‹å®š/è£œå‡éœ€è¦ä¸Šç­çš„å°ç£äººæ•¸ï¼›é€±å…­ç”±ç§»å·¥æ’ç­æ˜¯å¦æœ‰äººä¸Šç­æ±ºå®š 2/3ï¼‰
const DUTY_SAT_CELL = 'è¨­å®š!C2';  // ä¿ç•™ï¼ˆä¸ä¸»ç”¨ï¼‰
const DUTY_NAT_CELL = 'è¨­å®š!D2';  // åœ‹å®š/è£œå‡éœ€ä¸Šç­äººæ•¸ï¼ˆç•™ç©º=å…¨éƒ¨ä¸Šç­ï¼‰

// å‘½å
const ROSTER_PREFIX  = 'ç­è¡¨_';
const CAL_PREFIX     = 'æ—¥æ›†_';
const MIGRANT_PREFIX = 'ç§»å·¥æ’ç­_';

// è¦–è¦º
const COLOR_HEAD_BG = '#111111', COLOR_HEAD_FG = '#ffffff', COLOR_BAR_BG  = '#f5f7fa';
const COLOR_GUODING = '#FDE2E1', COLOR_BUJIA   = '#E1F0FF', COLOR_BUBAN   = '#FFEAD6', COLOR_SAT = '#EEEEEE';
const COLOR_WORK    = '#C8E6C9', COLOR_OFF     = '#ECEFF1';

// å…¶ä»–
const BUFFER_ROWS = 60;


/***** =================== é¸å–® =================== *****/
function onOpen(){
  SpreadsheetApp.getUi()
    .createMenu('å‡æ—¥ / ç­è¡¨')
    .addItem('ä¸€éµåˆå§‹åŒ–ï¼ˆæˆæ¬Š/æ¨£å¼/DBï¼‰', 'OneClick_Setup')
    .addSeparator()
    .addItem('å»ºç«‹/é‡å»º DBï¼ˆåˆä½µæ‰€æœ‰ CSVï¼‰', 'Build_DB_All')
    .addItem('å‡æ—¥æ¸…å–®â†’å¥—å…¬å¼ï¼ˆå…¨å¹´é¡¯ç¤ºï¼‰', 'Enable_Formula_Mode_YearOnly')
    .addSeparator()
    .addItem('å»ºç«‹/é‡å»º äººå“¡è¨­å®šé ', 'People_InitSheet')
    .addItem('å»ºç«‹/é‡å»º ç§»å·¥æ’ç­é ', 'Migrant_InitSheet')
    .addSeparator()
    .addItem('ç”Ÿæˆ ç­è¡¨ï¼ˆè®€ç§»å·¥æ’ç­ï¼‰', 'Roster_Generate_Fair')
    .addItem('ç”Ÿæˆ æ—¥æ›†ï¼ˆä¸€ï½æ—¥ï¼‰', 'Calendar_BuildLocal')
    .addSeparator()
    .addItem('è¼¸å‡ºï¼šç­è¡¨â†’è³‡æ–™å¤¾ï¼ˆè¦†è“‹ï¼‰', 'Export_Roster_ToDrive')
    .addItem('è¼¸å‡ºï¼šæ—¥æ›†â†’è³‡æ–™å¤¾ï¼ˆè¦†è“‹ï¼‰', 'Export_Calendar_ToDrive')
    .addItem('è¼¸å‡ºï¼šç§»å·¥æ’ç­â†’è³‡æ–™å¤¾ï¼ˆè¦†è“‹ï¼‰', 'Export_Migrant_ToDrive')
    .addItem('ä¸€éµè¼¸å‡ºï¼šç­è¡¨+æ—¥æ›†', 'Export_Both_ToDrive')
    .addSeparator()
    .addItem('çµ±è¨ˆï¼šæ›´æ–°ï¼ˆå¹´ æˆ– å¹´+æœˆï¼‰', 'Stats_Update')
    .addSeparator()
    .addItem('å•Ÿç”¨å³æ™‚åƒ…åŒæ­¥å‚™è¨»', 'Setup_Auto')   // åªåŒæ­¥å‚™è¨»ï¼Œä¸è‡ªå‹•é‡ç®—
    .addItem('åœç”¨å³æ™‚åŒæ­¥', 'Remove_Auto')
    .addToUi();
}


/***** =================== ä¸€éµåˆå§‹åŒ– =================== *****/
function OneClick_Setup(){
  Grant_Permissions();                 // é¦–æ¬¡æˆæ¬Š
  Settings_ApplyLayout();              // è¨­å®šé ï¼ˆä¹¾æ·¨ã€å«å¿«é€Ÿæ“ä½œã€å‚™è¨»ï¼‰
  Init_HolidaySheet_Once();            // å‡æ—¥æ¸…å–®æ¨£å¼
  Build_DB_All();                      // åˆä½µ CSV â†’ _DB_ALLï¼ˆå«è‡ªå‹•è£œæ¯å¹´é€±å…­ï¼‰
  Enable_Formula_Mode_YearOnly();      // å‡æ—¥æ¸…å–® = å…¨å¹´å…¬å¼
  People_InitSheet();                  // äººå“¡è¨­å®šï¼ˆåœ‹å®šå‡æ—¥Y/Nï¼‰
  Migrant_InitSheet();                 // ç§»å·¥æ’ç­ï¼ˆç°¡åŒ–ç‰ˆï¼‰
  toast_('åˆå§‹åŒ–å®Œæˆï¼šè«‹å…ˆåœ¨ã€Œäººå“¡è¨­å®šã€ã€Œç§»å·¥æ’ç­ã€å¡«å¥½ï¼Œå†åˆ°ã€Œè¨­å®šã€å¿«é€Ÿæ“ä½œè¼¸å…¥ GO ç”Ÿæˆç­è¡¨/æ—¥æ›†');
}


/***** =============== è¨­å®šé ï¼ˆä¹¾æ·¨ + å¿«é€Ÿæ“ä½œ + ç¾åŒ–å‚™è¨»ï¼‰ =============== *****/
function Settings_ApplyLayout(){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName('è¨­å®š') || ss.insertSheet('è¨­å®š');

  // ä¿ç•™èˆŠå€¼
  const oldYear   = _numOrEmpty_(sh.getRange('A2').getValue());
  const oldMonth  = _numOrEmpty_(sh.getRange('B2').getValue());
  const oldMobile = !!sh.getRange(MOBILE_CELL).getValue();
  const oldNote   = String(sh.getRange(NOTE_CELL).getValue() || '');

  sh.clear().setHiddenGridlines(true).setTabColor('#1f1f1f');

  // æ¨™é ­
  sh.getRange(1,1,1,10).setBackground(COLOR_HEAD_BG);
  sh.getRange(1,1).setValue('è¨­å®š').setFontColor(COLOR_HEAD_FG).setFontWeight('bold');

  // å·¦å´ä¸»è¨­å®š
  sh.getRange(1,1,1,4)
    .setValues([['å¹´ä»½','æœˆä»½','ä¾‹å‡æ—¥éœ€ä¸Šç­(å°ç£)','åœ‹å®š/è£œå‡éœ€ä¸Šç­']])
    .setFontColor(COLOR_HEAD_FG).setFontWeight('bold');

  sh.getRange(2,1,1,4).setBackground('#f5f7fa').setBorder(true,true,true,true,false,false);
  sh.getRange('B2').setDataValidation(SpreadsheetApp.newDataValidation().requireNumberBetween(1,12).build());

  sh.getRange('D3').setValue(oldMobile ? true : false);
  sh.getRange('C3:D3').merge().setValue('æ‰‹æ©Ÿæ¨¡å¼ï¼ˆTRUE=å¤§å­—å¤§æ ¼ï¼‰').setFontColor('#666');

  // ç‹€æ…‹åˆ—
  sh.getRange('A4:B4').merge().setBackground('#fafafa').setBorder(true,true,true,true,false,false);
  ApplyStatusFormula_YearOnly_();

  // å³å´ï¼šå¿«é€Ÿæ“ä½œï¼ˆè¼¸å…¥ GO è§¸ç™¼ï¼‰
  sh.getRange('F1').setValue('å¿«é€Ÿæ“ä½œ').setFontWeight('bold').setFontColor(COLOR_HEAD_FG);
  sh.getRange('F2:H2').setValues([['â–¶ ç”Ÿæˆç­è¡¨','â–¶ ç”Ÿæˆæ—¥æ›†','â–¶ ç”Ÿæˆç­è¡¨+æ—¥æ›†']]);
  sh.getRange('F3:H3').setValues([['åœ¨ä¸Šæ–¹æ ¼è¼¸å…¥ GO','åœ¨ä¸Šæ–¹æ ¼è¼¸å…¥ GO','åœ¨ä¸Šæ–¹æ ¼è¼¸å…¥ GO']]).setFontColor('#666');
  ['F2','G2','H2'].forEach(a1=>{
    sh.getRange(a1).setBackground('#fff').setBorder(true,true,true,true,false,false)
      .setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList(['GO'], true).setAllowInvalid(true).build())
      .setNote('è¼¸å…¥ GO å¾ŒæŒ‰ Enter è§¸ç™¼å°æ‡‰å‹•ä½œï¼ŒçµæŸæœƒè‡ªå‹•æ¸…ç©º');
  });

  // å‚™è¨»ï¼ˆç§»åˆ° A6ï¼›åˆä½µ A6:D10ï¼‰
  sh.getRange('A5:D5').merge().setValue('ğŸ“ å‚™è¨»ï¼ˆæœƒå°åœ¨ç­è¡¨èˆ‡æ—¥æ›†åº•éƒ¨ï¼‰').setFontWeight('bold');
  const noteRange = sh.getRange('A6:D10'); noteRange.merge();
  sh.getRange(NOTE_CELL).setValue(oldNote);
  noteRange.setBackground('#fafafa').setWrap(true)
    .setBorder(true,true,true,true,false,false)
    .setHorizontalAlignment('left').setVerticalAlignment('top');
  sh.setRowHeight(6, 80); sh.setRowHeight(7, 80); sh.setRowHeight(8, 80); sh.setRowHeight(9, 80); sh.setRowHeight(10, 80);

  // æ¬„å¯¬èª¿æ•´ï¼ˆä¹¾æ·¨ä¸äº‚ï¼‰
  sh.setColumnWidths(1,1,100); sh.setColumnWidths(2,1,80);
  sh.setColumnWidth(3,150); sh.setColumnWidth(4,150);
  sh.setColumnWidth(5,520);
  sh.setColumnWidth(6,140); sh.setColumnWidth(7,140); sh.setColumnWidth(8,160);

  // ä½¿ç”¨èªªæ˜
  sh.getRange('E7').setValue('èªªæ˜ï¼š\n1) å…ˆå¡«äººå“¡è¨­å®šï¼ˆé †åº=é¡¯ç¤ºé †åºï¼‰èˆ‡ç§»å·¥æ’ç­ï¼ˆé è¨­ä¸Šç­ï¼Œé¸å–®å¯æ”¹ä¼‘å‡ï¼‰ã€‚\n2) åˆ°å³ä¸Šå¿«é€Ÿæ“ä½œè¼¸å…¥ GO ç”Ÿæˆç­è¡¨/æ—¥æ›†ã€‚\n3) åªæœ‰æ­¤è™•å‚™è¨»æ”¹å‹•æœƒå³æ™‚åŒæ­¥ã€‚')
    .setFontColor('#666').setWrap(true);

  if (oldYear)  sh.getRange('A2').setValue(oldYear);
  if (oldMonth) sh.getRange('B2').setValue(oldMonth);
  toast_('è¨­å®šåˆ†é å®Œæˆï¼ˆå‚™è¨»å·²ç§»åˆ°å¹´æœˆä¸‹æ–¹ï¼‰');
}


/***** =============== å‡æ—¥æ¸…å–®ï¼ˆå›ºå®šè‰²ç¢¼å€ + å…¨å¹´ï¼‰ =============== *****/
function Init_HolidaySheet_Once(){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(TARGET_SHEET) || ss.insertSheet(TARGET_SHEET);

  sh.clear().setHiddenGridlines(true).setTabColor('#1f1f1f');

  sh.getRange(1,1,1,9).setBackground(COLOR_HEAD_BG);
  sh.getRange('A1').setValue('å‡æ—¥ / è£œå‡ / è£œç­ / é€±å…­ï¼ˆå…¨å¹´ï¼‰')
    .setFontWeight('bold').setFontColor(COLOR_HEAD_FG);
  sh.getRange('B1').setValue('â€”').setFontColor(COLOR_HEAD_FG);
  sh.getRange('A2').setValue('ä¾†æºï¼š_DB_ALLã€€æ›´æ–°ï¼šâ€”').setFontColor('#444');

  sh.getRange(3,1,1,3).setValues([['æ—¥æœŸ','é¡å‹(åœ‹å®š/è£œå‡/è£œç­/é€±å…­)','èªªæ˜']])
    .setFontWeight('bold').setBackground(COLOR_BAR_BG).setBorder(true,true,true,true,true,true);

  sh.setFrozenRows(3);
  sh.setColumnWidth(1,120); sh.setColumnWidth(2,160); sh.setColumnWidth(3,600);

  drawLegend_Fixed_(sh);
  applyTypeValidation_(sh, 1);
  applyColorRules_(sh, 1);
  try { sh.getRange(3,1,2,3).createFilter(); } catch(_) {}

  toast_('å‡æ—¥æ¸…å–®å°±ç·’');
}
function drawLegend_Fixed_(sh){
  sh.getRange('H1:I1').merge().setValue('è‰²ç¢¼èªªæ˜').setFontWeight('bold').setHorizontalAlignment('left');
  [['åœ‹å®š',COLOR_GUODING],['è£œå‡',COLOR_BUJIA],['è£œç­',COLOR_BUBAN],['é€±å…­',COLOR_SAT]].forEach((it,i)=>{
    const r=2+i; sh.getRange(r,8).setValue(it[0]); sh.getRange(r,9).setValue(' ').setBackground(it[1]).setBorder(true,true,true,true,false,false);
  });
}


/***** =============== DBï¼šåˆä½µ CSVï¼ˆå«è‡ªå‹•è£œé€±å…­ï¼‰ =============== *****/
function Build_DB_All(){
  const folder = getFolderSafe_(CSV_FOLDER_ID); if (!folder) return;
  const data = [], yearSet = {}, dedup = {};
  const it = folder.getFiles(); let cnt=0;
  while (it.hasNext()){
    const f = it.next(); const m = /å‡æ—¥æ¸…å–®_(20\d{2})\.csv$/i.exec(f.getName()); if (!m) continue; cnt++;
    const text = f.getBlob().getDataAsString('UTF-8').replace(/^\uFEFF/,'');
    const csv  = Utilities.parseCsv(text); if (!csv || csv.length<2) continue;
    const h = csv[0].map(x=>String(x).trim());
    const iD=h.indexOf('æ—¥æœŸ'), iT=h.findIndex(x=>x==='é¡å‹'||x.startsWith('é¡å‹')), iS=h.indexOf('èªªæ˜');
    if (iD===-1 || iT===-1 || iS===-1) continue;
    for (let r=1;r<csv.length;r++){
      const row=csv[r]; if(!row||!row.length) continue;
      const dStr=String(row[iD]).trim(); if(!dStr) continue;
      const dObj=toDateObj_(dStr); if(!dObj) continue;
      const typ=String(row[iT]||'').trim(), note=String(row[iS]||'').trim(), y=dObj.getFullYear();
      yearSet[y]=1; const key=fmtYMD_(dObj)+'|'+typ+'|'+note;
      if(dedup[key]) continue; dedup[key]=1;
      data.push([dObj, typ, note, y]);
    }
  }
  // è‡ªå‹•è£œé€±å…­
  Object.keys(yearSet).forEach(yStr=>{
    const y=Number(yStr); let d=new Date(y,0,1);
    while (d.getFullYear()===y){
      if (d.getDay()===6){
        const key=fmtYMD_(d)+'|é€±å…­|ä¾‹å‡æ—¥';
        if(!dedup[key]){ dedup[key]=1; data.push([new Date(d),'é€±å…­','ä¾‹å‡æ—¥',y]); }
      }
      d.setDate(d.getDate()+1);
    }
  });
  data.sort((a,b)=> a[0]-b[0]);

  const ss=SpreadsheetApp.getActive();
  let db=ss.getSheetByName(DB_SHEET) || ss.insertSheet(DB_SHEET);
  db.clear();
  db.getRange(1,1,1,4).setValues([['æ—¥æœŸ','é¡å‹','èªªæ˜','å¹´']]).setFontWeight('bold');
  if(data.length) db.getRange(2,1,data.length,4).setValues(data);
  db.getRange(2,1,Math.max(1,data.length),1).setNumberFormat('yyyy-mm-dd');
  db.hideSheet();
  toast_(`DB å®Œæˆï¼šåˆä½µ ${cnt} æª”ï¼Œç¸½åˆ— ${data.length}`);
}


/***** =============== å‡æ—¥æ¸…å–®ï¼šå…¨å¹´å…¬å¼ï¼ˆå®‰å…¨ï¼‰ =============== *****/
function Enable_Formula_Mode_YearOnly(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(TARGET_SHEET) || ss.insertSheet(TARGET_SHEET);
  const last=sh.getLastRow(); if(last>=4) sh.getRange(4,1,last-3,3).clearContent();

  const fData = `
=LET(
  yTxt, ${YEAR_CELL},
  yRaw, IFERROR(VALUE(yTxt),""),
  y, IF(yRaw="","", IF(yRaw<1911, yRaw+1911, yRaw)),
  IF(yRaw="",
    "",
    IFERROR(QUERY(${DB_SHEET}!A:D,
      "select A,B,C where D="&y&" order by A label A '', B '', C ''",1),
    {})
  )
)`.trim();
  sh.getRange('A4').setFormula(fData);

  const fTitle = `
=LET(
  yTxt, ${YEAR_CELL},
  yRaw, IFERROR(VALUE(yTxt),""),
  y, IF(yRaw="","", IF(yRaw<1911, yRaw+1911, yRaw)),
  roc, IF(yRaw="","", y-1911),
  IF(yRaw="","â€”","æ°‘åœ‹ "&roc&" / è¥¿å…ƒ "&y)
)`.trim();
  sh.getRange('B1').setFormula(fTitle).setFontColor(COLOR_HEAD_FG);

  sh.getRange('A2').setFormula(`="ä¾†æºï¼š(DB)ã€€æ›´æ–°ï¼š"&TEXT(NOW(),"yyyy-mm-dd HH:mm")`).setFontColor('#444');

  applyTypeValidation_(sh, 1);
  applyColorRules_(sh, 1);
  ApplyStatusFormula_YearOnly_();
  toast_('å‡æ—¥æ¸…å–®ï¼ˆå…¨å¹´ï¼‰å·²å¥—å…¬å¼');
}


/***** =============== äººå“¡è¨­å®šï¼ˆä¿ç•™èˆŠè³‡æ–™ï¼›ç©ºç™½æ‰æ”¾é è¨­ï¼‰ =============== *****/
function People_InitSheet(){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(PEOPLE_SHEET);

  // å–èˆŠè³‡æ–™
  let oldRows = [];
  if (sh) {
    const last = sh.getLastRow();
    if (last >= 2) {
      oldRows = sh.getRange(2, 1, last - 1, 6).getValues()
        .filter(r => String(r[1]).trim() !== '')
        .map(r => ([
          r[0] === true,
          String(r[1]).trim(),
          (String(r[2]).trim() || 'å°ç£'),
          yn_(r[3]) ? 'Y' : 'N',  // æ¥å—å¤šç¨®å€¼
          yn_(r[4]) ? 'Y' : 'N',
          String(r[5] || '').trim()
        ]));
    }
  }

  // è‹¥ç„¡ä»»ä½•è³‡æ–™ â†’ æ”¾ä¸€æ¬¡é è¨­åå–®
  if (!oldRows.length) {
    oldRows = [
      [true,'ç‹ä¼¯å®‡','å°ç£','Y','Y',''],
      [true,'è³´å¨ŸåŸ','å°ç£','Y','Y',''],
      [true,'å³æ€¡ç‘Ÿ','å°ç£','Y','Y',''],
      [true,'æ—æ–‡ç¾©','å°ç£','N','Y',''],
      [true,'å»ºå€«','ç§»å·¥','Y','Y',''],
      [true,'å‚‘æ–¯','ç§»å·¥','Y','Y','']
    ];
  }

  if (!sh) sh = ss.insertSheet(PEOPLE_SHEET);
  sh.clear().setHiddenGridlines(true).setTabColor('#1f1f1f');

  sh.getRange(1,1,1,6).setValues([['å•Ÿç”¨','å§“å','ç¾¤çµ„(å°ç£/ç§»å·¥)','é€±å…­ä¸Šç­(Y/N)','åœ‹å®šå‡æ—¥(Y/N)','å‚™è¨»']])
    .setBackground(COLOR_BAR_BG).setFontWeight('bold').setBorder(true,true,true,true,true,true);
  sh.setFrozenRows(1);

  sh.setColumnWidth(1,70);  sh.setColumnWidth(2,140);
  sh.setColumnWidth(3,120); sh.setColumnWidth(4,130);
  sh.setColumnWidth(5,140); sh.setColumnWidth(6,220);

  sh.getRange('A2:A500').insertCheckboxes();
  sh.getRange('C2:C500').setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList(['å°ç£','ç§»å·¥'], true).build());
  sh.getRange('D2:D500').setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList(['Y','N'], true).build());
  sh.getRange('E2:E500').setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList(['Y','N'], true).build());

  sh.getRange(2, 1, oldRows.length, 6).setValues(oldRows);

  sh.getRange('H1').setValue('ä½¿ç”¨èªªæ˜').setFontWeight('bold');
  sh.getRange('H2').setValue('å¯å¡« Y/Nï¼Œä¹Ÿæ¥å—ï¼šYES/NOã€TRUE/FALSEã€1/0ã€æ’ç­/ä¼‘å‡ã€å¯/ä¸å¯ã€æ˜¯/å¦ã€‚')
    .setFontColor('#666').setWrap(true);

  toast_('äººå“¡è¨­å®šé å®Œæˆï¼šå·²ä¿ç•™/å¸¶å›åŸè³‡æ–™ï¼ˆç©ºç™½æ‰æ”¾é è¨­åå–®ï¼‰');
}


/***** ====== ç§»å·¥æ’ç­ï¼ˆç°¡åŒ–ï¼šæ²’æœ‰æ—©æ™šç­ï¼›é è¨­ä¸Šç­ï¼›å¯å¡«å¤šç¨®ã€Œä¼‘ã€å­—ï¼‰ ====== *****/

// å»ºç«‹æˆ–é‡å»ºï¼ˆB1=å¹´ã€C1=æœˆï¼›èˆ‡è¨­å®šé è„«é‰¤ï¼‰
function Migrant_InitSheet(){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(MIGRANT_SHEET) || ss.insertSheet(MIGRANT_SHEET);

  const now = new Date();
  const oldY = Number(String(sh.getRange('B1').getValue()).replace(/[^\d]/g,'')) || now.getFullYear();
  const oldM = Number(String(sh.getRange('C1').getValue()).replace(/[^\d]/g,'')) || (now.getMonth()+1);

  sh.clear();
  sh.setHiddenGridlines(true).setTabColor('#546E7A');

  // æ¨™é ­ + æ“ä½œèªªæ˜ï¼ˆä¹¾æ·¨ï¼‰
  sh.getRange(1,1,1,8).setValues([['å¹´','','æœˆ','','','æ“ä½œï¼šé è¨­ä¸Šç­ï¼›è¦æ’ä¼‘è«‹æŠŠæ ¼å­æ”¹æˆã€Œä¼‘å‡/ä¼‘/ä¼‘æ¯/OFFã€ã€‚','','']])
    .setBackground(COLOR_HEAD_BG).setFontColor(COLOR_HEAD_FG).setFontWeight('bold');

  sh.getRange('B1').setValue(oldY);
  sh.getRange('C1').setValue(oldM).setDataValidation(SpreadsheetApp.newDataValidation().requireNumberBetween(1,12).build());

  _Migrant_RebuildForMonth_();
  toast_('ç§»å·¥æ’ç­å°±ç·’ï¼ˆé è¨­ä¸Šç­ï¼›æ”¯æ´ ä¼‘å‡/ä¼‘/ä¼‘æ¯/OFFï¼‰');
}

// ä¾å¹´/æœˆé‡å»ºï¼šåç¨±é †åºåš´æ ¼ä¾ã€Œäººå“¡è¨­å®šã€å‡ºç¾é †åº
function _Migrant_RebuildForMonth_(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(MIGRANT_SHEET); if (!sh) return;

  const Y = Number(String(sh.getRange('B1').getValue()).replace(/[^\d]/g,'')) || 0;
  const M = Number(String(sh.getRange('C1').getValue()).replace(/[^\d]/g,'')) || 0;
  if (!Y || M<1 || M>12){ uiAlert_('è«‹åœ¨ã€Œç§»å·¥æ’ç­ã€B1/C1 å¡«å…¥æ­£ç¢ºçš„å¹´/æœˆ'); return; }

  const people = _readPeople_();                           // ä¿æŒåŸè¡¨é †åº
  const migrants = people.filter(p => p.group==='ç§»å·¥').map(p=>p.name);
  _Migrant_DrawSkeleton_Simple_(sh, Y, M, migrants);
}

function _Migrant_DrawSkeleton_Simple_(sh, Y, M, migrantNames){
  // æš«å­˜åŒå¹´æœˆèˆŠå€¼ï¼ˆç”¨æ¨™æº–åŒ–æ—¥æœŸ keyï¼‰
  const old = {};
  const lastR = sh.getLastRow(), lastC = sh.getLastColumn();
  if (lastR>=4 && lastC>=2){
    const vals  = sh.getRange(4,1,lastR-3,lastC).getValues();
    vals.forEach(row=>{
      const k = dateKey_(row[0]);
      if(k) old[k]=row;
    });
  }

  // æ¸…è¡¨é ­ ~ ä¸»é«”ï¼ˆä¿ç•™ç¬¬ 1 åˆ—ï¼‰
  sh.getRange(2,1,500,100).clear();

  // è¡¨é ­ç¬¬ 3 åˆ—ï¼šæ—¥æœŸ + æ¯ä½ç§»å·¥ä¸€çµ„ï¼ˆç‹€æ…‹ã€å‚™è¨»ã€spacerï¼‰
  const headers=['æ—¥æœŸ'];
  migrantNames.forEach(nm => headers.push(nm,'å‚™è¨»','')); // spacer
  if (headers[headers.length-1]==='') headers.pop();
  sh.getRange(3,1,1,headers.length).setValues([headers])
    .setBackground(COLOR_BAR_BG).setFontWeight('bold').setBorder(true,true,true,true,true,true);

  // æ¬„å¯¬
  sh.setColumnWidth(1, 120);
  let c=2;
  migrantNames.forEach(()=>{
    sh.setColumnWidth(c++, 120); // ç‹€æ…‹
    sh.setColumnWidth(c++, 160); // å‚™è¨»
    if (c<=headers.length) sh.setColumnWidth(c++, 20); // spacer
  });

  // æ—¥æœŸåˆ—ï¼šç”¨ Date + æŒ‡å®šé¡¯ç¤ºæ ¼å¼
  const days = _daysInMonth_(Y,M);
  const data = [];
  for (let d=1; d<=days; d++){ data.push([new Date(Y, M-1, d)]); }
  sh.getRange(4,1,days,1).setValues(data).setNumberFormat('yyyy-mm-dd');

  // é è¨­å…¨ã€Œä¸Šç­ã€ï¼›æä¾›ä¸‹æ‹‰ï¼ˆä¼‘å‡ï¼‰
  for (let i=0;i<migrantNames.length;i++){
    const col = 2 + i*3;
    sh.getRange(4,col,days,1).setValue('ä¸Šç­')
      .setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList(['ä¸Šç­','ä¼‘å‡'], true).setAllowInvalid(true).build());
  }
  sh.setFrozenRows(3);

  // å›å¡«èˆŠå€¼ï¼ˆåŒå¹´æœˆï¼‰
  for (let d=1; d<=days; d++){
    const key = fmtYMD_(new Date(Y, M-1, d));
    if (old[key]){
      const rowVals = old[key];
      sh.getRange(3+d,2,1,headers.length-1).setValues([rowVals.slice(1, headers.length)]);
    }
  }

  // ä½¿ç”¨èªªæ˜ï¼ˆæ·¡è‰²ï¼‰
  sh.getRange(2,1).setValue('èªªæ˜ï¼šæ­¤é æ±ºå®šç§»å·¥æ¯ä¸€å¤©æ˜¯å¦ä¸Šç­ã€‚é è¨­ç‚ºã€Œä¸Šç­ã€ï¼Œè¦æ’ä¼‘å¯å¡«ï¼šä¼‘å‡ / ä¼‘ / ä¼‘æ¯ / OFFã€‚')
    .setFontColor('#666').setWrap(true);
}

// è®€å‡ºæ¯æ—¥å“ªäº›ç§»å·¥ä¸Šç­ï¼ˆéµ=yyyy-mm-ddï¼›åˆ—ç©ºç™½â†’é è¨­æ‰€æœ‰ç§»å·¥ä¸Šç­ï¼‰
function Migrant_ReadPlan_(Yopt, Mopt){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(MIGRANT_SHEET);
  if (!sh) return { workSetByDate:{}, migrants:[] };

  const lastR = sh.getLastRow(), lastC = sh.getLastColumn();
  if (lastR<4 || lastC<2) return { workSetByDate:{}, migrants:[] };

  const heads = sh.getRange(3,1,1,lastC).getValues()[0];
  const vals  = sh.getRange(4,1,lastR-3,lastC).getValues();

  // æ“·å–ç§»å·¥åå­—ï¼ˆç¬¬ 3 åˆ—ä¸­æ¯ 3 æ¬„ä¸€å€‹åå­—ï¼‰
  const migrants=[];
  for (let c=2;c<=lastC;c+=3){
    const nm=String(heads[c-1]||'').trim();
    if(nm) migrants.push(nm);
  }
  const allSet = new Set(migrants);

  const workSetByDate={};
  vals.forEach(row=>{
    const key = dateKey_(row[0]); if(!key) return;
    const set = new Set();
    for (let j=0;j<migrants.length;j++){
      const c = 2 + j*3;
      const v = String(row[c]||'').trim();
      if (isRest_(v)) continue; // ä¼‘/ä¼‘å‡/ä¼‘æ¯/OFF
      set.add(migrants[j]);     // å…¶é¤˜ï¼ˆå«ç©ºç™½/ä¸Šç­ï¼‰è¦–ç‚ºä¸Šç­
    }
    workSetByDate[key] = set.size===0 ? new Set(allSet) : set;
  });
  return { workSetByDate, migrants };
}

// åŒ¯å‡ºç§»å·¥æ’ç­é 
function Export_Migrant_ToDrive(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(MIGRANT_SHEET);
  if (!sh){ uiAlert_('æ‰¾ä¸åˆ°ã€Œç§»å·¥æ’ç­ã€é '); return; }

  const Y = Number(String(sh.getRange('B1').getValue()).replace(/[^\d]/g,'')) || 0;
  const M = Number(String(sh.getRange('C1').getValue()).replace(/[^\d]/g,'')) || 0;
  if (!Y || M<1 || M>12){ uiAlert_('è«‹åœ¨ã€Œç§»å·¥æ’ç­ã€B1/C1 æŒ‡å®šæ­£ç¢ºçš„å¹´/æœˆ'); return; }

  const name = `${MIGRANT_PREFIX}${Y}-${('0'+M).slice(-2)}`;
  saveSheetToNewSpreadsheet_(sh, MIGRANT_OUT_FOLDER_ID, name);
  toast_('å·²è¼¸å‡ºã€Œç§»å·¥æ’ç­ã€è‡³è³‡æ–™å¤¾ï¼ˆåŒåè¦†è“‹ï¼‰');
}
function _daysInMonth_(Y,M){ return new Date(Y, M, 0).getDate(); }


/***** =============== ç”Ÿæˆç­è¡¨ï¼ˆå…¬å¹³ + ä¾ç§»å·¥æ’ç­ï¼‰ =============== *****/
function Roster_Generate_Fair(){
  const ss=SpreadsheetApp.getActive();
  const Y=_getYear_(), M=_getMonth_(); if(!Y||!M){ uiAlert_('è¨­å®šè«‹å¡« å¹´/æœˆ'); return; }
  const db=ss.getSheetByName(DB_SHEET); if(!db){ uiAlert_('è«‹å…ˆå»ºç«‹ DB'); return; }

  const people = _readPeople_(); if(!people.length){ uiAlert_('äººå“¡è¨­å®šæ²’æœ‰å•Ÿç”¨çš„äºº'); return; }
  const taiwan  = people.filter(p=>p.group==='å°ç£');
  const migrants= people.filter(p=>p.group==='ç§»å·¥');

  // ä¾ç§»å·¥æ’ç­ï¼ˆè‹¥æŸæ—¥æ²’æœ‰è¨˜éŒ„â†’é è¨­æ‰€æœ‰ç§»å·¥ä¸Šç­ï¼‰
  const { workSetByDate: migWorkByDate, migrants: migNames } = Migrant_ReadPlan_(Y,M);
  const migAllSet = new Set(migNames);

  // æœ¬æœˆå‡æ—¥
  const days = readMonthDaysFromDB_(Y,M,['é€±å…­','åœ‹å®š','è£œå‡','è£œç­']);
  if(!days.length){ uiAlert_('æœ¬æœˆæ²’æœ‰ é€±å…­/åœ‹å®š/è£œå‡/è£œç­'); return; }

  // æ­·å²ä¼‘çµ±è¨ˆï¼ˆå…¬å¹³ï¼šé€±å…­åªç®—å°ç£ï¼›åœ‹å®š/è£œå‡å…¨å“¡ï¼‰
  const hist = collectFairnessCounts_(Y,M);
  const liveSat={}, liveNat={};
  people.forEach(p=>{ liveSat[p.name]=hist[p.name]?.sat||0; liveNat[p.name]=hist[p.name]?.nat||0; });

  // å»ºè¡¨
  const mm=('0'+M).slice(-2), name=`${ROSTER_PREFIX}${Y}-${mm}`;
  let sh=ss.getSheetByName(name) || ss.insertSheet(name);
  sh.clear(); sh.setHiddenGridlines(true).setTabColor('#0B8043');

  sh.getRange(1,1,1,2).merge().setValue(`ç­è¡¨ Â· ${Y}-${mm}`)
    .setBackground(COLOR_HEAD_BG).setFontColor(COLOR_HEAD_FG).setFontWeight('bold');

  const head=['å§“å','ç¾¤çµ„'];
  days.forEach(d=>{
    const zh='æ—¥ä¸€äºŒä¸‰å››äº”å…­'[d.date.getDay()];
    head.push(`${d.date.getMonth()+1}/${d.date.getDate()}(${zh}) ${d.type}`);
  });
  sh.getRange(2,1,1,head.length).setValues([head])
    .setBackground(COLOR_BAR_BG).setFontWeight('bold').setBorder(true,true,true,true,true,true);
  sh.setFrozenRows(2);

  const mobile = !!ss.getRange(MOBILE_CELL).getValue();
  sh.setColumnWidth(1, mobile? 140:120);
  sh.setColumnWidth(2, mobile? 140:120);
  for(let c=3;c<=head.length;c++) sh.setColumnWidth(c, mobile? 110:90);
  sh.getRange(1,1,2,head.length).setFontSize(mobile? 12:10);

  const out = people.map(p=>[p.name,p.group]);

  days.forEach(d=>{
    const key = fmtYMD_(d.date);

    if (d.type==='è£œç­'){
      people.forEach(p=> out.find(r=>r[0]===p.name).push('ä¸Šç­'));
      return;
    }

    if (d.type==='é€±å…­'){
      // ç§»å·¥
      const workingSet = migWorkByDate[key] ? migWorkByDate[key] : new Set(migAllSet);
      migrants.forEach(p=>{
        const v = workingSet.has(p.name) ? 'ä¸Šç­' : 'ä¼‘';
        out.find(r=>r[0]===p.name).push(v);
      });

      // å°ç£ï¼šè‹¥ä»»ä½•ç§»å·¥ä¸Šç­â†’å°ç£éœ€ 2 äººï¼›å¦å‰‡ 3 äºº
      const required = workingSet.size>0 ? 2 : 3;
      const elig = taiwan.filter(p=>yn_(p.satYN));
      const assigned = Math.min(required, elig.length);
      const canRest  = Math.max(0, elig.length - assigned);

      const sorted = elig.slice().sort((a,b)=>{
        const da=(liveSat[a.name]||0)-(liveSat[b.name]||0); if(da) return da;
        return 0;
      });
      const restSet = new Set(sorted.slice(0,canRest).map(p=>p.name));

      taiwan.forEach(p=>{
        let v='ä¼‘';
        if (yn_(p.satYN)) v = restSet.has(p.name)? 'ä¼‘':'ä¸Šç­';
        if (v==='ä¼‘') liveSat[p.name]=(liveSat[p.name]||0)+1;
        out.find(r=>r[0]===p.name).push(v);
      });
      return;
    }

    // åœ‹å®š / è£œå‡
    const workingSet = migWorkByDate[key] ? migWorkByDate[key] : new Set(migAllSet);
    migrants.forEach(p=>{
      const v = workingSet.has(p.name) ? 'ä¸Šç­' : 'ä¼‘';
      out.find(r=>r[0]===p.name).push(v);
      if (v==='ä¼‘') liveNat[p.name]=(liveNat[p.name]||0)+1;
    });

    // å°ç£ï¼šDUTY_NAT_CELL ç•™ç©º = å…¨å“¡ä¸Šç­ï¼›å¡«æ•¸å­— = å…¬å¹³è¼ªæµåªæ’è©²æ•¸
    const dutyNatRaw = String(ss.getRange(DUTY_NAT_CELL).getValue()).trim();
    const dutyNat = dutyNatRaw==='' ? null : asNonNegInt_(dutyNatRaw, 0);
    const eligTW  = taiwan.filter(p=>yn_(p.natYN));

    if (dutyNat === null){
      // å…¨å“¡ä¸Šç­
      taiwan.forEach(p=>{
        const v = yn_(p.natYN) ? 'ä¸Šç­' : 'ä¼‘';
        out.find(r=>r[0]===p.name).push(v);
        if (v==='ä¼‘') liveNat[p.name]=(liveNat[p.name]||0)+1;
      });
    }else{
      const workTW  = Math.min(dutyNat, eligTW.length);
      const canRest = Math.max(0, eligTW.length - workTW);
      const sortedTW = eligTW.slice().sort((a,b)=>{
        const da=(liveNat[a.name]||0)-(liveNat[b.name]||0); if(da) return da;
        return 0;
      });
      const restSetTW = new Set(sortedTW.slice(0,canRest).map(p=>p.name));
      taiwan.forEach(p=>{
        let v = (yn_(p.natYN) && !restSetTW.has(p.name)) ? 'ä¸Šç­' : 'ä¼‘';
        out.find(r=>r[0]===p.name).push(v);
        if (v==='ä¼‘') liveNat[p.name]=(liveNat[p.name]||0)+1;
      });
    }
  });

  sh.getRange(3,1,out.length,head.length).setValues(out);

  // æ‰‹å‹•èª¿æ•´ä¸‹æ‹‰
  const dv = SpreadsheetApp.newDataValidation().requireValueInList(['ä¸Šç­','ä¼‘'], true).build();
  sh.getRange(3,3,out.length,head.length-2).setDataValidation(dv);

  // è‘—è‰² + åœ–ä¾‹
  applyHolidayRosterColors_(sh, out.length, head.length);
  drawSimpleLegend_(sh);

  // å‚™è¨»ï¼ˆåŒæ­¥è¨­å®šé  NOTE_CELLï¼‰
  const note = String(ss.getRange(NOTE_CELL).getValue()||'').trim();
  const noteRow = Math.max(5+out.length, 24);
  sh.getRange(noteRow,1,1,Math.max(6, head.length)).merge().setValue(note || ' ğŸ“ å‚™è¨»ï¼š')
    .setBackground('#fafafa').setWrap(true).setBorder(true,true,true,true,false,false);
  sh.setRowHeight(noteRow, 120);

  toast_(`å®Œæˆï¼š${name} Â· äººæ•¸ ${out.length} Â· æ¬„ä½ ${days.length}`);
}


/***** =============== ç”Ÿæˆæ—¥æ›†ï¼ˆå«é€±å…­ï¼›åå­—ç›´æ’ï¼›ç§»é™¤ã€Œä¸Šç­ï¼šã€å­—æ¨£ï¼‰ =============== *****/
function Calendar_BuildLocal(){
  const ss=SpreadsheetApp.getActive();
  const Y=_getYear_(), M=_getMonth_(); if(!Y||!M){ uiAlert_('è¨­å®šè«‹å¡« å¹´/æœˆ'); return; }

  // äººå“¡é †åºï¼ˆç”¨æ–¼åå–®æ’åºï¼‰
  const people = _readPeople_();
  const orderIdx = {}; people.forEach((p,i)=> orderIdx[p.name]=i);

  // å¾ç­è¡¨æŠ“ã€Œä¸Šç­ã€åå–®ï¼ˆå«é€±å…­/åœ‹å®š/è£œå‡/è£œç­ï¼‰
  const rosterName = `${ROSTER_PREFIX}${Y}-${('0'+M).slice(-2)}`;
  const roster = ss.getSheetByName(rosterName);
  const workMap = {}; // 'yyyy-mm-dd' -> ['ç‹å°æ˜','â€¦']
  const typeMap = {};
  if (roster){
    const lastR=roster.getLastRow(), lastC=roster.getLastColumn();
    if (lastR>=3 && lastC>=3){
      const heads = roster.getRange(2,3,1,lastC-2).getValues()[0];
      const colInfo = heads.map(h=>{
        const s=String(h||''); const m=/(\d{1,2})\/(\d{1,2}).*?(åœ‹å®š|è£œå‡|è£œç­|é€±å…­)$/.exec(s);
        if(!m) return null;
        const mm=('0'+m[1]).slice(-2), dd=('0'+m[2]).slice(-2), t=m[3];
        return {key: `${Y}-${mm}-${dd}`, type: t};
      });
      const vals = roster.getRange(3,1,lastR-2,lastC).getValues();
      vals.forEach(row=>{
        const name=String(row[0]||'').trim(); if(!name) return;
        for (let c=0;c<colInfo.length;c++){
          const info=colInfo[c]; if(!info) continue;
          const v = String(row[2+c]||'').trim();
          if (v==='ä¸Šç­'){ (workMap[info.key]||(workMap[info.key]=[])).push(name); }
          if (!typeMap[info.key]) typeMap[info.key]=info.type;
        }
      });
    }
  }
  // åå–®ä¾ã€Œäººå“¡è¨­å®šã€é †åºé‡æ’
  Object.keys(workMap).forEach(k=>{
    workMap[k].sort((a,b)=> (orderIdx[a]??999) - (orderIdx[b]??999));
  });

  // å–å¾—æœˆå‡æ—¥ï¼ˆè‘—è‰²ï¼‰
  const holidays = readMonthDaysFromDB_(Y,M,['åœ‹å®š','è£œå‡','è£œç­','é€±å…­']);
  const hType = {}; // yyyy-mm-dd -> { guoding:[], bujia:[], buban:true, sat:true }
  holidays.forEach(h=>{
    const k = fmtYMD_(h.date);
    if (!hType[k]) hType[k] = {guoding:[], bujia:[], buban:false, sat:false};
    if (h.type==='åœ‹å®š') hType[k].guoding.push(h.note||'åœ‹å®š');
    if (h.type==='è£œå‡') hType[k].bujia.push(h.note||'è£œå‡');
    if (h.type==='è£œç­') hType[k].buban = true;
    if (h.type==='é€±å…­')  hType[k].sat   = true;
  });

  // å»º/æ¸… æ—¥æ›†é 
  const name='æ—¥æ›†';
  let sh=ss.getSheetByName(name) || ss.insertSheet(name);
  sh.clear();
  sh.setHiddenGridlines(true).setTabColor('#5B6B7A');

  // æ¨™é¡Œ
  sh.getRange(1,1).setValue(`${Y} å¹´ ${M} æœˆ`).setFontWeight('bold').setFontSize(14).setHorizontalAlignment('left');

  // æ¬„é ­ï¼šä¸€ï½æ—¥ï¼ˆ7 æ¬„ï¼‰
  const days = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
  sh.getRange(2,1,1,7).setValues([days])
    .setFontWeight('bold').setBackground(COLOR_BAR_BG).setBorder(true,true,true,true,true,true);

  // 6Ã—7 æ ¼
  const rows = 6, cols = 7;
  sh.getRange(3,1,rows,cols).setBorder(true,true,true,true,true,true).setVerticalAlignment('top');

  // å°ºå¯¸ï¼šæ ¼å­åŠ é«˜
  const mobile = !!ss.getRange(MOBILE_CELL).getValue();
  for(let c=1;c<=cols;c++) sh.setColumnWidth(c, mobile? 130:115);
  for(let r=3;r<3+rows;r++) sh.setRowHeight(r, mobile? 190:160);

  // å¡«å…§å®¹
  const first = new Date(Y, M-1, 1);
  const startWeekday = ((first.getDay()+6)%7); // 0..6ï¼Œ0=é€±ä¸€æ¬„
  const daysInMonth = _daysInMonth_(Y,M);

  for (let d=1, row=0, col=startWeekday; d<=daysInMonth; d++){
    const key = fmtYMD_(new Date(Y, M-1, d));
    const a1 = sh.getRange(3+row, 1+col);

    let text = String(d);
    const tag = [];
    if ((hType[key]?.guoding||[]).length) tag.push('ï¼ˆ'+hType[key].guoding.join('ã€')+'ï¼‰');
    if ((hType[key]?.bujia||[]).length)   tag.push('ï¼ˆ'+hType[key].bujia.join('ã€')+'ï¼‰');
    if (hType[key]?.buban)                 tag.push('ï¼ˆè£œç­ï¼‰');
    if (tag.length) text += ' ' + tag.join('ã€');

    // åå­—ç›´æ’ï¼ˆä¸å†é¡¯ç¤ºã€Œä¸Šç­ï¼šã€ï¼‰
    const names = workMap[key] || [];
    if (names.length){
      text += '\n' + names.map(n => 'â€¢ ' + n).join('\n');
    }

    a1.setValue(text).setWrapStrategy(SpreadsheetApp.WrapStrategy.WRAP)
      .setHorizontalAlignment('left').setFontSize(mobile? 12:11);

    // èƒŒæ™¯è‰²ï¼šåœ‹å®š > è£œå‡ > è£œç­ > é€±å…­
    if ((hType[key]?.guoding||[]).length) a1.setBackground(COLOR_GUODING);
    else if ((hType[key]?.bujia||[]).length) a1.setBackground(COLOR_BUJIA);
    else if (hType[key]?.buban) a1.setBackground(COLOR_BUBAN);
    else if (hType[key]?.sat)   a1.setBackground(COLOR_SAT);

    // ä¸‹ä¸€æ ¼
    col++; if (col>=7){ col=0; row++; if (row>=rows) break; }
  }

  // å‚™è¨»ï¼ˆåŠ é«˜ï¼‰
  const note = String(ss.getRange(NOTE_CELL).getValue()||'').trim();
  const noteStartRow = 3+rows+1;
  sh.getRange(noteStartRow,1,1,cols).merge().setValue(note || ' ğŸ“ å‚™è¨»ï¼š')
    .setBackground('#fafafa').setWrap(true).setBorder(true,true,true,true,false,false);
  sh.setRowHeight(noteStartRow, 160);

  toast_('æ—¥æ›†ï¼ˆæœ¬æª”ï¼‰å®Œæˆ');
}


/***** =============== è¼¸å‡ºåˆ°è³‡æ–™å¤¾ï¼ˆè¦†è“‹ï¼‰ =============== *****/
function Export_Roster_ToDrive(){
  const ss=SpreadsheetApp.getActive();
  const Y=_getYear_(), M=_getMonth_(); if(!Y||!M){ uiAlert_('è¨­å®šè«‹å¡« å¹´/æœˆ'); return; }
  const name=`${ROSTER_PREFIX}${Y}-${('0'+M).slice(-2)}`;
  const sh = ss.getSheetByName(name); if(!sh){ uiAlert_('è«‹å…ˆç”Ÿæˆç­è¡¨'); return; }
  saveSheetToNewSpreadsheet_(sh, ROSTER_FOLDER_ID, name);
  toast_('å·²è¼¸å‡ºç­è¡¨è‡³è³‡æ–™å¤¾ï¼ˆè¦†è“‹åŒåï¼‰');
}
function Export_Calendar_ToDrive(){
  const ss=SpreadsheetApp.getActive();
  const Y=_getYear_(), M=_getMonth_(); if(!Y||!M){ uiAlert_('è¨­å®šè«‹å¡« å¹´/æœˆ'); return; }
  Calendar_BuildLocal(); // ç¢ºä¿æœ€æ–°
  const sh = ss.getSheetByName('æ—¥æ›†'); if(!sh){ uiAlert_('æœªæ‰¾åˆ°æ—¥æ›†é '); return; }
  const name=`${CAL_PREFIX}${Y}-${('0'+M).slice(-2)}`;
  saveSheetToNewSpreadsheet_(sh, CAL_FOLDER_ID, name);
  toast_('å·²è¼¸å‡ºæ—¥æ›†è‡³è³‡æ–™å¤¾ï¼ˆè¦†è“‹åŒåï¼‰');
}
function Export_Both_ToDrive(){ Export_Roster_ToDrive(); Export_Calendar_ToDrive(); }


/***** =============== çµ±è¨ˆï¼ˆä¸é¡¯ç¤ºåˆè¨ˆä¼‘ï¼‰ =============== *****/
function Stats_Update(){
  const ss=SpreadsheetApp.getActive();
  let sh=ss.getSheetByName(STATS_SHEET) || ss.insertSheet(STATS_SHEET);
  sh.clear().setHiddenGridlines(true).setTabColor('#6D4C41');

  sh.getRange(1,1,1,2).setValues([['å¹´ä»½','æœˆä»½(ç©º=æ•´å¹´)']]).setBackground(COLOR_BAR_BG).setFontWeight('bold');
  sh.getRange(2,1,1,2).setBackground('#f5f7fa').setBorder(true,true,true,true,false,false);

  const Y=_getYear_(), M=_getMonth_(true);
  sh.getRange(2,1).setValue(Y); sh.getRange(2,2).setValue(M||'');

  const folder = getFolderSafe_(ROSTER_FOLDER_ID); if(!folder) return;
  const it=folder.getFiles(); const files=[];
  while (it.hasNext()){
    const f=it.next(); const m=/^ç­è¡¨_(\d{4})-(\d{2})$/.exec(f.getName()); if(!m) continue;
    const y=+m[1], mo=+m[2]; if (y!==Y) continue; if (M && mo!==M) continue;
    files.push({id:f.getId(), y, mo});
  }
  if(!files.length){ uiAlert_('æ‰¾ä¸åˆ°è©²å¹´/æœˆçš„ç­è¡¨æª”'); return; }
  files.sort((a,b)=> a.y!==b.y ? a.y-b.y : a.mo-b.mo);

  const map={}; // name -> {satOff:0, natOff:0, bujiaOff:0}
  files.forEach(f=>{
    const wb = SpreadsheetApp.openById(f.id);
    const sheets = wb.getSheets().filter(s=>/^ç­è¡¨_\d{4}-\d{2}$/.test(s.getName()));
    if(!sheets.length) return;
    const s=sheets[0]; const lastR=s.getLastRow(), lastC=s.getLastColumn(); if (lastR<3 || lastC<3) return;

    const heads=s.getRange(2,3,1,lastC-2).getValues()[0];
    const cats=heads.map(h=>{
      const t=String(h||'');
      if (t.endsWith('é€±å…­')) return 'sat';
      if (t.endsWith('åœ‹å®š')) return 'guoding';
      if (t.endsWith('è£œå‡')) return 'bujia';
      if (t.endsWith('è£œç­')) return 'buban';
      return '';
    });

    const vals=s.getRange(3,1,lastR-2,lastC).getValues();
    vals.forEach(row=>{
      const nm=String(row[0]||'').trim(); if(!nm) return;
      if(!map[nm]) map[nm]={satOff:0, natOff:0, bujiaOff:0};
      for (let c=0;c<cats.length;c++){
        const cat=cats[c]; if(!cat) continue;
        const v=String(row[2+c]||'').trim();
        if (v!=='ä¼‘') continue;
        if (cat==='sat') map[nm].satOff++;
        if (cat==='guoding') map[nm].natOff++;
        if (cat==='bujia') map[nm].bujiaOff++;
      }
    });
  });

  const rows = Object.keys(map).sort((a,b)=> a.localeCompare(b,'zh-Hant'))
    .map(n=>[n, map[n].satOff, map[n].natOff, map[n].bujiaOff]);
  sh.getRange(4,1,1,4).setValues([['å§“å','é€±å…­ä¼‘','åœ‹å®šä¼‘','è£œå‡ä¼‘']])
    .setBackground(COLOR_BAR_BG).setFontWeight('bold');
  if(rows.length) sh.getRange(5,1,rows.length,4).setValues(rows);

  const mobile = !!ss.getRange(MOBILE_CELL).getValue();
  sh.setColumnWidth(1, mobile? 180:150);
  sh.setColumnWidth(2, 100); sh.setColumnWidth(3,100); sh.setColumnWidth(4, 100);
  sh.getRange(4,1,Math.max(2,rows.length+1),4).setBorder(true,true,true,true,true,true);
  sh.getRange(4,1,rows.length+1,4).setWrap(true);

  // èªªæ˜
  sh.getRange('F1').setValue('èªªæ˜').setFontWeight('bold');
  sh.getRange('F2').setValue('æ­¤è¡¨åªè¨ˆä¼‘å‡æ¬¡æ•¸ï¼šé€±å…­åªç®—å°ç£äººï¼›åœ‹å®š/è£œå‡å…¨å“¡ã€‚').setFontColor('#666').setWrap(true);

  toast_('çµ±è¨ˆå·²æ›´æ–°');
}


/***** =============== å³æ™‚è§¸ç™¼ï¼ˆåªåŒæ­¥å‚™è¨»ï¼›å…¶é¤˜ç”¨ã€Œè¨­å®šâ†’GOã€ï¼‰ =============== *****/
function Setup_Auto(){
  Remove_Auto();
  ScriptApp.newTrigger('Auto_OnEdit').forSpreadsheet(SpreadsheetApp.getActive()).onEdit().create();
  toast_('å·²å•Ÿç”¨ï¼šåƒ…åœ¨ä¿®æ”¹ å‚™è¨»å€ï¼ˆA6 èµ·ï¼‰æ™‚ï¼Œé‡æ–°å¯«å…¥ç­è¡¨/æ—¥æ›†å‚™è¨»ï¼›ç”Ÿæˆè«‹åœ¨è¨­å®šé è¼¸å…¥ GOã€‚');
}
function Remove_Auto(){
  ScriptApp.getProjectTriggers().forEach(t=>{ if(t.getHandlerFunction()==='Auto_OnEdit') ScriptApp.deleteTrigger(t); });
  toast_('å·²åœç”¨å³æ™‚åŒæ­¥');
}
function Auto_OnEdit(e){
  if(!e) return;
  const r=e.range, sh=r.getSheet(), name=sh.getName(), val = r.getValue();
  try{
    if (name === 'è¨­å®š'){
      const a1 = r.getA1Notation();
      const noteTopLeft = NOTE_CELL.split('!')[1]; // ä¾‹å¦‚ A6

      // å¿«é€Ÿæ“ä½œï¼šè¼¸å…¥ GO è§¸ç™¼ï¼ˆäº‹å¾Œæ¸…ç©ºï¼‰
      if (a1==='F2' && String(val).toUpperCase()==='GO'){ Roster_Generate_Fair(); sh.getRange(a1).clearContent(); return; }
      if (a1==='G2' && String(val).toUpperCase()==='GO'){ Calendar_BuildLocal(); sh.getRange(a1).clearContent(); return; }
      if (a1==='H2' && String(val).toUpperCase()==='GO'){ Roster_Generate_Fair(); Calendar_BuildLocal(); sh.getRange(a1).clearContent(); return; }

      // å‚™è¨»ï¼šå³æ™‚åŒæ­¥ï¼ˆåªé‡å¯«å‚™è¨»æ¡†ï¼Œä¸é‡ç®—æ•´å¼µï¼‰
      if (a1===noteTopLeft){
        _RewriteNoteOnly_('ç­è¡¨_', String(val||''));
        _RewriteNoteOnly_('æ—¥æ›†', String(val||''), true);
        return;
      }
    }
    // ç§»å·¥æ’ç­ï¼šæ”¹å¹´/æœˆå³é‡å»ºéª¨æ¶
    if (name === MIGRANT_SHEET && (r.getA1Notation()==='B1' || r.getA1Notation()==='C1')){
      _Migrant_RebuildForMonth_();
    }
  }catch(err){ Logger.log(err); }
}
// åªæ›´æ–°å‚™è¨»æ¡†ï¼ˆé¿å…æ•´å¼µé‡ç®—ï¼‰
function _RewriteNoteOnly_(sheetPrefix, note, isCalendar){
  const ss = SpreadsheetApp.getActive();
  if (isCalendar){
    const sh = ss.getSheetByName('æ—¥æ›†'); if (!sh) return;
    const rows=6, cols=7; const noteStartRow = 3+rows+1;
    sh.getRange(noteStartRow,1,1,cols).merge().setValue(note || ' ğŸ“ å‚™è¨»ï¼š');
    return;
  }
  const Y=_getYear_(), M=_getMonth_(); if (!Y||!M) return;
  const name = `${sheetPrefix}${Y}-${('0'+M).slice(-2)}`;
  const sh = ss.getSheetByName(name); if (!sh) return;
  const noteRow = Math.max(5+ (sh.getLastRow()-2), 24);
  sh.getRange(noteRow,1,1,Math.max(6, sh.getLastColumn())).merge().setValue(note || ' ğŸ“ å‚™è¨»ï¼š');
}


/***** =============== å·¥å…·ï¼šè®€ DB / äººå“¡ / å…¬å¹³çµ±è¨ˆ =============== *****/
function readMonthDaysFromDB_(Y,M,types){
  const ss=SpreadsheetApp.getActive(), db=ss.getSheetByName(DB_SHEET);
  const set=new Set(Array.isArray(types)? types: [types]);
  const vals=db.getRange(2,1,db.getLastRow()-1,4).getValues();
  const out=[];
  vals.forEach(r=>{
    const d=r[0], t=r[1], note=r[2];
    if(!(d instanceof Date)) return;
    if(d.getFullYear()===Y && (d.getMonth()+1)===M){
      if(set.has(t)) out.push({date:new Date(d), type:t, note:String(note||'')});
    }
  });
  out.sort((a,b)=> a.date-b.date);
  return out;
}
function _readPeople_(){
  const ss=SpreadsheetApp.getActive(), sh=ss.getSheetByName(PEOPLE_SHEET);
  if(!sh) return [];
  const last=Math.max(sh.getLastRow(),2);
  const arr=sh.getRange(2,1,last-1,6).getValues(); // ä¸æ’åºï¼Œä¿ç•™å‡ºç¾é †åº
  return arr.filter(r=> r[0]===true && String(r[1]).trim()!=='')
    .map(r=>({
      name:String(r[1]).trim(),
      group:String(r[2]).trim(),
      satYN: yn_(r[3]) ? 'Y':'N',   // å¯¬é¬†è§£æ
      natYN: yn_(r[4]) ? 'Y':'N'
    }));
}

// å…¬å¹³çµ±è¨ˆï¼šè®€æœ¬æª” + è³‡æ–™å¤¾æ—¢æœ‰ç­è¡¨ï¼ˆåŒå¹´ã€éå»æœˆï¼‰
function collectFairnessCounts_(targetYear, targetMonth){
  const map={};
  const ss=SpreadsheetApp.getActive();
  const sheets=ss.getSheets().map(s=>s.getName()).filter(n=>/^ç­è¡¨_\d{4}-\d{2}$/.test(n)).sort();
  for (const name of sheets){
    const m=/^ç­è¡¨_(\d{4})-(\d{2})$/.exec(name); if(!m) continue;
    const y=+m[1], mo=+m[2];
    if (y!==targetYear || mo>=targetMonth) continue;
    _accFromRosterSheet_(ss.getSheetByName(name), map);
  }
  const folder = getFolderSafe_(ROSTER_FOLDER_ID);
  if (folder){
    const it=folder.getFiles();
    while (it.hasNext()){
      const f=it.next(); const mm=/^ç­è¡¨_(\d{4})-(\d{2})$/.exec(f.getName());
      if (!mm) continue;
      const y=+mm[1], mo=+mm[2];
      if (y!==targetYear || mo>=targetMonth) continue;
      try{
        const wb = SpreadsheetApp.openById(f.getId());
        const s = wb.getSheetByName(f.getName());
        if (s) _accFromRosterSheet_(s, map);
      }catch(_){}
    }
  }
  return map;
}
function _accFromRosterSheet_(s, map){
  if(!s) return;
  const lastR=s.getLastRow(), lastC=s.getLastColumn(); if (lastR<3 || lastC<3) return;
  const heads=s.getRange(2,3,1,lastC-2).getValues()[0];
  const cats=heads.map(h=>{
    const t=String(h||'');
    if (t.indexOf('é€±å…­')>=0) return 'sat';
    if (t.indexOf('åœ‹å®š')>=0 || t.indexOf('è£œå‡')>=0) return 'nat';
    return '';
  });
  const vals=s.getRange(3,1,lastR-2,lastC).getValues();
  vals.forEach(row=>{
    const nm=String(row[0]||'').trim(); const grp=String(row[1]||'').trim(); if(!nm) return;
    if(!map[nm]) map[nm]={sat:0,nat:0};
    for (let c=0;c<cats.length;c++){
      if (!cats[c]) continue;
      const v=String(row[2+c]||'').trim();
      if (v!=='ä¼‘') continue;
      if (cats[c]==='sat' && grp==='å°ç£') map[nm].sat++;
      if (cats[c]==='nat') map[nm].nat++;
    }
  });
}


/***** =============== è¼¸å‡ºå·¥å…· / é©—è­‰ / è‘—è‰² / ç‹€æ…‹åˆ— / å°å·¥å…· =============== *****/
function saveSheetToNewSpreadsheet_(sheet, folderId, newName){
  const folder = getFolderSafe_(folderId); if(!folder) return;
  const existing = folder.getFilesByName(newName);
  while (existing.hasNext()){ existing.next().setTrashed(true); }
  const newSS = SpreadsheetApp.create(newName);
  const newFile = DriveApp.getFileById(newSS.getId());
  const parent = newFile.getParents(); while (parent.hasNext()){ parent.next().removeFile(newFile); }
  folder.addFile(newFile);

  const target = newSS.getActiveSheet();
  target.setName(sheet.getName());
  const range = sheet.getDataRange();
  const values = range.getValues(), formats = range.getNumberFormats(), bg = range.getBackgrounds();
  const fontSizes = range.getFontSizes(), fontWeights = range.getFontWeights();
  target.clear();
  target.getRange(1,1,values.length,values[0].length).setValues(values);
  target.getRange(1,1,formats.length,formats[0].length).setNumberFormats(formats);
  target.getRange(1,1,bg.length,bg[0].length).setBackgrounds(bg);
  target.getRange(1,1,fontSizes.length,fontSizes[0].length).setFontSizes(fontSizes);
  target.getRange(1,1,fontWeights.length,fontWeights[0].length).setFontWeights(fontWeights);
}

function applyTypeValidation_(sh, dataRows){
  const n = Math.max(1,(dataRows||1)+BUFFER_ROWS);
  const rule = SpreadsheetApp.newDataValidation().requireValueInList(['åœ‹å®š','è£œå‡','è£œç­','é€±å…­'], true).setAllowInvalid(true).build();
  sh.getRange(4,2,n,1).setDataValidation(rule);
}
function applyColorRules_(sh, dataRows){
  const n=Math.max(1,(dataRows||1)+BUFFER_ROWS), rng=sh.getRange(4,1,n,3);
  sh.setConditionalFormatRules([
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied('=$B4="åœ‹å®š"').setBackground(COLOR_GUODING).setRanges([rng]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied('=$B4="è£œå‡"').setBackground(COLOR_BUJIA).setRanges([rng]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied('=$B4="è£œç­"').setBackground(COLOR_BUBAN).setRanges([rng]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied('=$B4="é€±å…­"').setBackground(COLOR_SAT).setRanges([rng]).build(),
  ]);
}
function applyHolidayRosterColors_(sh, rows, cols){
  const rng = sh.getRange(3,3,Math.max(1,rows),Math.max(1,cols-2));
  sh.setConditionalFormatRules([
    SpreadsheetApp.newConditionalFormatRule().whenTextEqualTo('ä¸Šç­').setBackground(COLOR_WORK).setRanges([rng]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenTextEqualTo('ä¼‘').setBackground(COLOR_OFF).setRanges([rng]).build(),
  ]);
}
function drawSimpleLegend_(sh){
  const col = Math.max(10, sh.getLastColumn()+2);
  sh.getRange(1,col,1,2).merge().setValue('åœ–ä¾‹').setFontWeight('bold');
  sh.getRange(2,col).setValue('ä¸Šç­'); sh.getRange(2,col+1).setValue(' ').setBackground(COLOR_WORK).setBorder(true,true,true,true,false,false);
  sh.getRange(3,col).setValue('ä¼‘');   sh.getRange(3,col+1).setValue(' ').setBackground(COLOR_OFF).setBorder(true,true,true,true,false,false);
}
function ApplyStatusFormula_YearOnly_(){
  const ss=SpreadsheetApp.getActive();
  const f=`=IFERROR(
    LET(yTxt,${YEAR_CELL}, yRaw,IFERROR(VALUE(yTxt),""), y,IF(yRaw="","",IF(yRaw<1911,yRaw+1911,yRaw)), roc,IF(yRaw="","",y-1911),
    rng,IF(yRaw="","",FILTER('${TARGET_SHEET}'!A4:A,'${TARGET_SHEET}'!A4:A<>"")), n,IF(yRaw="","",ROWS(rng)),
    IF(yRaw="","å°šæœªè¼‰å…¥","å·²è¼‰å…¥ï¼šæ°‘åœ‹ "&roc&"ï¼ˆè¥¿å…ƒ "&y&"ï¼‰ Â· å…¨å¹´ï¼Œå…± "&n&" åˆ—ã€€æ–¼ "&TEXT(NOW(),"yyyy-mm-dd HH:mm")) ) ,
  "å°šæœªè¼‰å…¥")`;
  ss.getRange(STATUS_CELL).setFormula(f);
}

function _getYear_(){
  const raw=Number(String(SpreadsheetApp.getActive().getRange(YEAR_CELL).getValue()).replace(/[^\d]/g,'')); if(!raw) return null;
  return raw<1911? raw+1911 : raw;
}
function _getMonth_(allowEmpty){
  const s=String(SpreadsheetApp.getActive().getRange(MONTH_CELL).getValue()).trim();
  if (!s && allowEmpty) return null;
  const n=Number(s.replace(/[^\d]/g,'')); return (n>=1 && n<=12)? n : null;
}
function getFolderSafe_(id){
  try { return DriveApp.getFolderById(id); }
  catch(e){ uiAlert_('è®€å–è³‡æ–™å¤¾å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™ï¼š\n'+e); return null; }
}
function toDateObj_(s){
  if (!s) return null;
  const t=String(s).trim();
  let m=/^(\d{4})-(\d{1,2})-(\d{1,2})$/.exec(t); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  m=/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/.exec(t); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  const d=new Date(t); return isNaN(d)? null : d;
}
function fmtYMD_(d){ const mm=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return d.getFullYear()+'-'+mm+'-'+dd; }
function _numOrEmpty_(v){ const n=Number(String(v).replace(/[^\d]/g,'')); return isNaN(n)? '' : n; }
function asNonNegInt_(v, def){ const n=Number(String(v).replace(/[^\d]/g,'')); return Number.isFinite(n)? Math.max(0,Math.floor(n)) : def; }
function toast_(m){ SpreadsheetApp.getActive().toast(m,'æç¤º',3); }
function uiAlert_(m){ SpreadsheetApp.getUi().alert(m); }
function Grant_Permissions(){ DriveApp.getRootFolder(); toast_('æˆæ¬Š OK'); }

// å·¥å…·ï¼šå­—ä¸² â†’ å¸ƒæ—ï¼ˆå¤šèªç³»/å¤šå¯«æ³•ï¼‰
function yn_(v){
  const s = String(v||'').trim().toLowerCase();
  if (!s) return false;
  return ['y','yes','true','1','æ’ç­','å¯','æ˜¯'].includes(s);
}
// å·¥å…·ï¼šã€Œä¼‘ã€çš„åˆ¤æ–·ï¼ˆç§»å·¥æ’ç­ï¼‰
function isRest_(v){
  const s = String(v||'').trim().toLowerCase();
  return s==='ä¼‘' || s==='ä¼‘å‡' || s==='ä¼‘æ¯' || s==='off';
}
// æ—¥æœŸ key æ¨™æº–åŒ–ï¼ˆDate æˆ– æ–‡å­—éƒ½è½‰æˆ yyyy-mm-ddï¼‰
function dateKey_(v){
  if (v instanceof Date) return fmtYMD_(v);
  const d = toDateObj_(v);
  return d ? fmtYMD_(d) : String(v||'').trim();
}
